<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props"
          Condition="Exists('$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props')"/>
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <ProjectGuid>{B48AE228-2997-4A2C-93BF-BBC4C9EA0806}</ProjectGuid>
    <OutputType>Library</OutputType>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <RootNamespace>MyHeadTrackingCar</RootNamespace>
    <AssemblyName>MyHeadTrackingCar</AssemblyName>
    <TargetFrameworkVersion>v3.5</TargetFrameworkVersion>
    <FileAlignment>512</FileAlignment>
    <TargetFrameworkProfile>Unity Full v3.5</TargetFrameworkProfile>
    <LangVersion>latest</LangVersion>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <PlatformTarget>AnyCPU</PlatformTarget>
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <OutputPath>bin\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug MWC|AnyCPU' ">
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <OutputPath>bin\Debug\</OutputPath>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug MSC|AnyCPU' ">
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <OutputPath>bin\Debug\</OutputPath>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <PlatformTarget>AnyCPU</PlatformTarget>
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <OutputPath>bin\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
  </PropertyGroup>
  <ItemGroup>
    <Reference Include="0Harmony">
      <HintPath>D:\SteamLibrary\steamapps\common\My Summer Car\mysummercar_Data\Managed\0Harmony.dll</HintPath>
    </Reference>
    <Reference Include="Assembly-CSharp-firstpass">
      <HintPath>D:\SteamLibrary\steamapps\common\My Summer Car\mysummercar_Data\Managed\Assembly-CSharp-firstpass.dll</HintPath>
    </Reference>
    <Reference Include="MSCLoader">
      <HintPath>D:\SteamLibrary\steamapps\common\My Summer Car\mysummercar_Data\Managed\MSCLoader.dll</HintPath>
    </Reference>
    <Reference Include="PlayMaker">
      <HintPath>D:\SteamLibrary\steamapps\common\My Summer Car\mysummercar_Data\Managed\PlayMaker.dll</HintPath>
    </Reference>
    <Reference Include="System"/>
    <Reference Include="System.Core"/>
    <Reference Include="System.Data"/>
    <Reference Include="System.Xml"/>
    <Reference Include="UnityEngine">
      <HintPath>D:\SteamLibrary\steamapps\common\My Winter Car\mywintercar_Data\Managed\UnityEngine.dll</HintPath>
    </Reference>
  </ItemGroup>
  <ItemGroup>
    <Compile Include="MouseLookWithModifiers.cs"/>
    <Compile Include="MyHeadTrackingCarSettings.cs"/>
    <Compile Include="Properties\AssemblyInfo.cs"/>
    <Compile Include="TrackIRFromKerbTrack\TrackIRClient.cs"/>
    <Compile Include="TrackIRFromKerbTrack\TrackIRTracker.cs"/>
    <Compile Include="MyHeadTrackingCarComponent.cs"/>
    <Compile Include="MyHeadTrackingCarMod.cs"/>
  </ItemGroup>
  <ItemGroup>
    <Content Include="Properties\Versions.props" />
  </ItemGroup>
  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets"/>
  <Target Name="DeployUnityMod"
          AfterTargets="Build"
          Condition=" '$(Configuration)' == 'Debug MSC' Or '$(Configuration)' == 'Debug MWC' ">
    <PropertyGroup>
      <ModsDir Condition="'$(Configuration)' == 'Debug MSC'">D:\SteamLibrary\steamapps\common\My Summer Car\Mods</ModsDir>
      <ModsDir Condition="'$(Configuration)' == 'Debug MWC'">D:\SteamLibrary\steamapps\common\My Winter Car\Mods</ModsDir>
    </PropertyGroup>
    <Copy SourceFiles="$(TargetPath)" DestinationFolder="$(ModsDir)" SkipUnchangedFiles="true"/>
    <Copy SourceFiles="$(TargetDir)$(TargetName).pdb" DestinationFolder="$(ModsDir)" SkipUnchangedFiles="true"/>
    <Exec Command="&quot;$(ModsDir)\debug.bat&quot;" WorkingDirectory="$(ModsDir)"/>
  </Target>
  <!-- 
  Because AssemblyVersion stays at 1.0.0.0 there is no easy way to fetch the version for the release ZIP creation 
  This is far from an optimal solution but it works well enough for this use case
  -->
  <UsingTask TaskName="GetFileVersion"
             TaskFactory="CodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
    <ParameterGroup>
      <AssemblyPath Required="true" />
      <FileVersion Output="true" />
    </ParameterGroup>
    <Task>
      <Code Type="Fragment" Language="cs">
        <![CDATA[ FileVersion = System.Diagnostics.FileVersionInfo.GetVersionInfo(AssemblyPath).FileVersion; ]]>
      </Code>
    </Task>
  </UsingTask>
  <Target Name="Publish"
          AfterTargets="Build"
          Condition=" '$(Configuration)' == 'Release' ">
    <!-- Delete old publish zips -->
    <ItemGroup>
      <ZipsToDelete Include="$(OutputPath)MyHeadTrackingCar-*.zip"/>
    </ItemGroup>
    <Delete Files="@(ZipsToDelete)" ContinueOnError="true"/>
    <!-- Create name for new zip -->
    <GetFileVersion AssemblyPath="$(TargetPath)">
      <Output TaskParameter="FileVersion" PropertyName="AssemblyFileVersion"/>
    </GetFileVersion>
    <PropertyGroup>
      <ZipFileName>$(OutputPath)MyHeadTrackingCar-$(AssemblyFileVersion).zip</ZipFileName>
    </PropertyGroup>
    <!-- Build zip with powershell because Zip is not yet present in this version of MSBuilt-->
    <Exec Command="powershell -NoProfile -Command Compress-Archive -Path '$(TargetPath)','$(SolutionDir)README.md','$(SolutionDir)LICENSE' -DestinationPath '$(ZipFileName)' -Force"
          IgnoreExitCode="true"
          ConsoleToMsBuild="true"/>
  </Target>
</Project>
